# MACD 计算详细示例（实际数据）

## 🎯 为什么需要 MACD 归一化？

### ❌ 问题：原始 MACD 在高价位资产失效

**场景对比：**

| 资产 | 价格 | EMA12 | EMA26 | 原始MACD | 是否合理？ |
|------|------|-------|-------|----------|-----------|
| **BTC** | 87,906 | 87,613 | 87,535 | **77.86** | ❌ 数值过大 |
| **ETH** | 3,000 | 3,015 | 3,000 | **15.00** | ✅ 数值正常 |
| **DOGE** | 0.30 | 0.301 | 0.300 | **0.001** | ❌ 数值过小 |

**问题：** 
- BTC 的 MACD=77.86 看起来"很大"，但实际只是 0.09% 的价格差
- 无法跨资产对比，无法设定统一阈值

---

## ✅ 解决方案：归一化为百分比

### 公式
```python
MACD% = (MACD绝对值 / 当前价格) × 100
```

### 归一化后对比

| 资产 | 价格 | 原始MACD | **归一化MACD%** | 可比性 |
|------|------|----------|-----------------|--------|
| **BTC** | 87,906 | 77.86 | **0.0886%** | ✅ 可比 |
| **ETH** | 3,000 | 15.00 | **0.5000%** | ✅ 可比 |
| **DOGE** | 0.30 | 0.001 | **0.3333%** | ✅ 可比 |

**现在可以统一判断：**
- MACD% > 0.5%: 强势信号
- MACD% > 0.2%: 中等信号
- MACD% < 0.1%: 弱信号

---

## 📊 实际计算示例（BTC 5分钟）

### 步骤1: 计算 EMA12 和 EMA26

#### 输入数据（最后3根K线）
```python
收盘价:
  K线98: 87,906.41
  K线99: 87,906.29  # 最新
```

#### EMA 计算公式
```python
α_12 = 2 / (12 + 1) = 0.1538
α_26 = 2 / (26 + 1) = 0.0741

EMA_12(今) = 价格(今) × α + EMA_12(昨) × (1 - α)
EMA_26(今) = 价格(今) × α + EMA_26(昨) × (1 - α)
```

#### 实际值
```python
# K线99 (最新)
价格 = 87,906.29

EMA_12 = 87,612.99  # 由ta库计算
EMA_26 = 87,535.13  # 由ta库计算
```

---

### 步骤2: 计算 MACD Line

```python
MACD = EMA_12 - EMA_26
     = 87,612.99 - 87,535.13
     = 77.86 USDT
```

---

### 步骤3: 计算 Signal Line（MACD的9期EMA）

```python
# Signal Line 是 MACD 的 9 期 EMA
α_9 = 2 / (9 + 1) = 0.2

Signal(今) = MACD(今) × 0.2 + Signal(昨) × 0.8

# 实际值
Signal = 13.63 USDT  # 由ta库计算
```

---

### 步骤4: 计算 MACD Histogram

```python
Histogram = MACD - Signal
          = 77.86 - 13.63
          = 64.23 USDT
```

---

### 步骤5: 归一化为百分比 ⭐

```python
# 归一化 MACD
MACD% = (77.86 / 87,906.29) × 100 = 0.0886%

# 归一化 Signal
Signal% = (13.63 / 87,906.29) × 100 = 0.0155%

# 归一化 Histogram
Histogram% = (64.23 / 87,906.29) × 100 = 0.0731%
```

---

## 📊 最终输出对比

### 原始 MACD（ta 库默认）
```python
{
  "macd": 77.86,           # USDT
  "macd_signal": 13.63,    # USDT
  "macd_diff": 64.23       # USDT
}
```

### 归一化 MACD（我们的修复）✅
```python
{
  "macd": 0.088577,        # %
  "macd_signal": 0.015505, # %
  "macd_diff": 0.073072    # %
}
```

---

## 🎯 实际应用：信号判断

### 代码实现
```python
def analyze_macd_signal(macd_pct, signal_pct):
    """
    基于归一化 MACD% 判断交易信号
    """
    if macd_pct > signal_pct and macd_pct > 0:
        # 金叉 + 在零轴上方
        if macd_pct > 0.5:
            return "强势看多"
        elif macd_pct > 0.2:
            return "中等看多"
        else:
            return "弱势看多"
    
    elif macd_pct > signal_pct:
        # 金叉但在零轴下方
        return "温和看多"
    
    elif macd_pct < signal_pct and macd_pct < 0:
        # 死叉 + 在零轴下方
        if macd_pct < -0.5:
            return "强势看空"
        elif macd_pct < -0.2:
            return "中等看空"
        else:
            return "弱势看空"
    
    else:
        # 死叉但在零轴上方
        return "温和看空"
```

### 当前状态分析
```python
macd = 0.0886%
signal = 0.0155%

判断：
  ✅ macd > signal (金叉)
  ✅ macd > 0 (零轴上方)
  ⚠️ macd < 0.2 (弱势)

结论: "弱势看多"
```

---

## 📈 历史趋势（最近10根K线）

| 时间 | MACD% | Signal% | Diff% | 信号 | 趋势 |
|------|-------|---------|-------|------|------|
| 18:00 | -0.0754 | -0.0397 | -0.0357 | 死叉 | ⬇️ |
| 18:05 | -0.0621 | -0.0417 | -0.0204 | 死叉 | ⬇️ |
| 18:10 | -0.0475 | -0.0415 | -0.0060 | 死叉 | ⬇️ |
| 18:15 | -0.0483 | -0.0425 | -0.0058 | 死叉 | ⬇️ |
| 18:20 | -0.0425 | -0.0422 | -0.0003 | 死叉 | ⬇️ |
| 18:25 | -0.0389 | -0.0410 | +0.0021 | **金叉** | ⬆️ |
| 18:30 | -0.0062 | -0.0237 | +0.0175 | 金叉 | ⬆️ |
| 18:35 | +0.0265 | -0.0004 | +0.0269 | 金叉 | ⬆️ |
| 18:40 | +0.0617 | +0.0131 | +0.0486 | 金叉 | ⬆️ |
| **18:45** | **+0.0886** | **+0.0155** | **+0.0731** | **金叉** | **⬆️** |

**关键点：**
- 18:25 **金叉出现**（MACD 上穿 Signal）
- 18:35 MACD 突破零轴（转为正值）
- 18:45 继续走强，Diff 扩大

---

## 🔍 为什么归一化很重要？

### 场景1: 跨资产策略
```python
# 如果你的策略需要同时交易 BTC 和 ETH

# ❌ 使用原始 MACD
if macd > 50:  # 这个阈值对 BTC 合适
    # 但对 ETH (价格3000) 永远不会触发
    # 对 DOGE (价格0.3) 永远会触发

# ✅ 使用归一化 MACD%
if macd_pct > 0.3:  # 这个阈值对所有资产都适用
    buy()
```

### 场景2: 历史回测
```python
# BTC 价格变化：2020年 $10,000 → 2024年 $87,000

# ❌ 原始 MACD
# 2020年: MACD = 10 → 很强
# 2024年: MACD = 10 → 很弱

# ✅ 归一化 MACD%
# 2020年: MACD% = 0.1% → 中等
# 2024年: MACD% = 0.1% → 中等（一致！）
```

### 场景3: 策略优化
```python
# ✅ 可以设定统一的阈值
BUY_SIGNAL_THRESHOLD = 0.3%   # 所有资产通用
SELL_SIGNAL_THRESHOLD = -0.3%  # 所有资产通用

# ❌ 如果用原始 MACD，每个资产需要不同阈值
BTC_BUY_THRESHOLD = 200  # BTC 专用
ETH_BUY_THRESHOLD = 10   # ETH 专用
DOGE_BUY_THRESHOLD = 0.001  # DOGE 专用
```

---

## 💡 代码实现（完整版）

```python
# src/data/processor.py 中的实现

def _calculate_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
    """计算技术指标"""
    
    # MACD - 使用归一化版本（百分比）
    # 原始 MACD 在高价位资产（如 BTC 8万）会有异常大的数值
    # 归一化为相对价格的百分比，使指标在不同价位下可比
    macd_indicator = MACD(close=df['close'])
    macd_raw = macd_indicator.macd()
    macd_signal_raw = macd_indicator.macd_signal()
    macd_diff_raw = macd_indicator.macd_diff()
    
    # 归一化：MACD / Price * 100 转为百分比
    # 这样 MACD 数值在 -1% 到 1% 之间，更符合实际交易判断
    df['macd'] = (macd_raw / df['close']) * 100
    df['macd_signal'] = (macd_signal_raw / df['close']) * 100
    df['macd_diff'] = (macd_diff_raw / df['close']) * 100
    
    return df
```

---

## 📊 验证测试

### 测试1: 不同价位资产
```python
# BTC at $87,906
macd_btc = 77.86
macd_pct_btc = 77.86 / 87906 * 100 = 0.0886%

# ETH at $3,000
macd_eth = 15.00
macd_pct_eth = 15.00 / 3000 * 100 = 0.5000%

# 结论：ETH 的信号更强（0.5% > 0.0886%）
```

### 测试2: 历史数据一致性
```python
# BTC 2021年价格 $60,000
macd_2021 = 60
macd_pct_2021 = 60 / 60000 * 100 = 0.1%

# BTC 2024年价格 $87,906
macd_2024 = 87.9
macd_pct_2024 = 87.9 / 87906 * 100 = 0.1%

# 结论：信号强度一致！✅
```

---

## 🎯 总结

### ✅ 归一化的优势

1. **跨资产可比** - 同一策略可用于 BTC、ETH、DOGE
2. **历史一致** - 2020年和2024年的信号可比
3. **阈值统一** - 不需要为每个资产调参
4. **更直观** - 0.3% 比 300 更容易理解
5. **专业性** - 符合专业量化交易标准

### 📈 实际效果

```python
# 当前状态（2025-12-16 18:45）
{
  "价格": 87906.29,
  "MACD%": 0.0886,      # 弱势看多
  "Signal%": 0.0155,
  "Diff%": 0.0731,      # 柱状图扩大
  
  "信号": "弱势看多",
  "建议": "观望或小仓位做多",
  "原因": "金叉刚形成，但强度不足"
}
```

---

*Generated on 2025-12-17*
*MACD Normalization Fix*
*BTC Price: $87,906*
*Signal: Weak Bullish (0.0886%)*
