# æ•°æ®å¯¹é½è¯Šæ–­æ€»ç»“

## è¯Šæ–­æ—¶é—´
2025-12-18 16:51:16 UTC

## æ ¸å¿ƒé—®é¢˜ç¡®è®¤ âœ…

### 1. æ•°æ®æ»åç°çŠ¶

å½“å‰ç³»ç»Ÿåœ¨å®ç›˜äº¤æ˜“ä¸­ä½¿ç”¨ `iloc[-2]`ï¼ˆæœ€åä¸€æ ¹å®Œæˆçš„Kçº¿ï¼‰ï¼Œå¯¼è‡´ä»¥ä¸‹æ»åï¼š

| å‘¨æœŸ | ä½¿ç”¨æ•°æ®æ—¶é—´ | å½“å‰æ—¶é—´ | å®é™…æ»å | è¯„ä¼° |
|------|-------------|---------|---------|------|
| 5m   | 16:45:00    | 16:51:16 | **6åˆ†é’Ÿ** | âœ… è½»å¾® |
| 15m  | 16:30:00    | 16:51:16 | **21åˆ†é’Ÿ** | âš ï¸ ä¸­ç­‰ |
| 1h   | 15:00:00    | 16:51:16 | **111åˆ†é’Ÿ** | ğŸ”´ ä¸¥é‡ |

### 2. å¤šå‘¨æœŸæ—¶é—´é”™ä½

åœ¨åŒä¸€æ—¶åˆ»çš„äº¤æ˜“å†³ç­–ä¸­ï¼Œç³»ç»Ÿæ··åˆä½¿ç”¨äº†ï¼š
- **5må‘¨æœŸ**: 16:45çš„æ•°æ®ï¼ˆ6åˆ†é’Ÿå‰ï¼‰
- **15må‘¨æœŸ**: 16:30çš„æ•°æ®ï¼ˆ21åˆ†é’Ÿå‰ï¼‰  
- **1hå‘¨æœŸ**: 15:00çš„æ•°æ®ï¼ˆ1å°æ—¶51åˆ†é’Ÿå‰ï¼‰

**æœ€å¤§æ—¶é—´å·®**: 105åˆ†é’Ÿï¼ˆ1.75å°æ—¶ï¼‰

è¿™æ„å‘³ç€ç³»ç»Ÿåœ¨ç”¨"è¿‘2å°æ—¶å‰çš„è¶‹åŠ¿åˆ¤æ–­"å’Œ"å‡ åˆ†é’Ÿå‰çš„çŸ­æœŸæ³¢åŠ¨"åšç»¼åˆå†³ç­–ï¼Œ**æ—¶é—´ç»´åº¦ä¸¥é‡ä¸ä¸€è‡´**ã€‚

---

## é£é™©è¯„ä¼° ğŸ”´

### é«˜é£é™©åœºæ™¯

1. **åè½¬ç­–ç•¥**
   - å½“1hçº§åˆ«å‡ºç°åè½¬ä¿¡å·æ—¶ï¼Œå®é™…ä¸Šæ˜¯1å°æ—¶51åˆ†é’Ÿå‰çš„ä¿¡å·
   - å¯èƒ½é”™è¿‡æœ€ä½³å…¥åœºæ—¶æœºï¼Œç”šè‡³åœ¨åè½¬å®Œæˆåæ‰å…¥åœº

2. **çªç ´ç­–ç•¥**  
   - 1hçº§åˆ«çš„çªç ´ä¿¡å·æ»åè¿‘2å°æ—¶
   - çªç ´åçš„æœ€ä½³è¿½è¸ªçª—å£æœŸï¼ˆé€šå¸¸15-30åˆ†é’Ÿï¼‰æ—©å·²è¿‡å»

3. **æ­¢æŸè§¦å‘å»¶è¿Ÿ**
   - å¦‚æœä¾èµ–1hçº§åˆ«çš„æ­¢æŸçº¿ï¼Œå®é™…ä»·æ ¼å¯èƒ½å·²ç»ä¸‹è·Œæ›´å¤š

### ä¸­é£é™©åœºæ™¯

1. **è¶‹åŠ¿è·Ÿéšç­–ç•¥**
   - å¦‚æœæ˜¯ç¨³å®šçš„å•è¾¹è¶‹åŠ¿ï¼Œ1-2å°æ—¶æ»åå½±å“è¾ƒå°
   - ä½†åœ¨éœ‡è¡å¸‚æˆ–è¶‹åŠ¿åè½¬æ—¶ï¼Œä¼šä¸¥é‡å½±å“æ”¶ç›Š

---

## å·²å®Œæˆå·¥ä½œ âœ…

### 1. æ–‡æ¡£æ›´æ–°
- âœ… `DATA_FLOW_STRUCTURED.md` æ–°å¢"å¤šå‘¨æœŸæ•°æ®å¯¹é½ä¸å®æ—¶æ€§é—®é¢˜"ç« èŠ‚
  - è¯¦ç»†è¯´æ˜æ»ååŸç†å’Œè®¡ç®—æ–¹æ³•
  - åˆ—å‡º3ç§è§£å†³æ–¹æ¡ˆï¼ˆå®æ—¶Kçº¿ã€ç»Ÿä¸€å·²å®ŒæˆKçº¿ã€æ··åˆç­–ç•¥ï¼‰
  - æä¾›æ˜ç¡®çš„ç­–ç•¥å»ºè®®

### 2. é…ç½®æ–‡ä»¶
- âœ… `config/data_alignment.yaml` åˆ›å»ºå®Œæˆ
  - å®šä¹‰äº†3ç§æ¨¡å¼ï¼š`backtest`ã€`live_safe`ã€`live_aggressive`
  - æ”¯æŒæŒ‰å‘¨æœŸé…ç½®å®æ—¶/æ»åæ¨¡å¼
  - åŒ…å«æ»åæ£€æµ‹å’Œå‘Šè­¦é˜ˆå€¼

### 3. è¯Šæ–­å·¥å…·
- âœ… `diagnose_data_lag.py` å¼€å‘å®Œæˆ
  - è‡ªåŠ¨æ‹‰å–æœ€æ–°æ•°æ®å¹¶è®¡ç®—æ»å
  - åˆ†æå¤šå‘¨æœŸæ—¶é—´é”™ä½
  - æä¾›ä¼˜åŒ–å»ºè®®
  - âœ… å·²ä¿®å¤æ—¶åŒºå¤„ç†bug

---

## å¾…å®Œæˆå·¥ä½œ ğŸ“‹

### ä¼˜å…ˆçº§1ï¼šé…ç½®å®æ—¶æ¨¡å¼ï¼ˆæ¨èï¼‰

#### æ–¹æ¡ˆAï¼šä¿®æ”¹ `src/features/builder.py`

å½“å‰é€»è¾‘ï¼š
```python
# æ‰€æœ‰å‘¨æœŸéƒ½ç”¨ iloc[-2]
for timeframe in timeframes:
    latest = df.iloc[-2]  # å›ºå®šä½¿ç”¨æ¬¡æ–°Kçº¿
```

æ”¹è¿›é€»è¾‘ï¼ˆæ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©ï¼‰ï¼š
```python
# åŠ è½½é…ç½®
alignment_config = load_yaml('config/data_alignment.yaml')
mode = alignment_config['mode']  # 'live_safe' æˆ– 'live_aggressive'

for timeframe in timeframes:
    # æ ¹æ®é…ç½®å’Œå‘¨æœŸé€‰æ‹©ç´¢å¼•
    if should_use_realtime(timeframe, mode):
        latest = df.iloc[-1]  # å®æ—¶Kçº¿ï¼ˆæœªå®Œæˆï¼‰
    else:
        latest = df.iloc[-2]  # å·²å®ŒæˆKçº¿ï¼ˆæ»åï¼‰
```

#### å»ºè®®é…ç½®ï¼ˆ`live_safe`æ¨¡å¼ï¼‰

```yaml
mode: 'live_safe'
timeframe_settings:
  5m:
    use_realtime: true   # 5åˆ†é’Ÿå®æ—¶ï¼Œæœ€å¤šæ»å5åˆ†é’Ÿ
  15m:
    use_realtime: true   # 15åˆ†é’Ÿå®æ—¶ï¼Œæœ€å¤šæ»å15åˆ†é’Ÿ
  1h:
    use_realtime: false  # 1å°æ—¶ä¿å®ˆï¼Œæ»å60-120åˆ†é’Ÿ
```

**æ•ˆæœ**ï¼š
- 5mæ»åï¼š1-5åˆ†é’Ÿï¼ˆå½“å‰6åˆ†é’Ÿ â†’ **0-5åˆ†é’Ÿ**ï¼‰
- 15mæ»åï¼š1-15åˆ†é’Ÿï¼ˆå½“å‰21åˆ†é’Ÿ â†’ **0-15åˆ†é’Ÿ**ï¼‰
- 1hæ»åï¼š60-120åˆ†é’Ÿï¼ˆä¿æŒä¸å˜ï¼Œä½†æ›´å¯æ§ï¼‰

---

### ä¼˜å…ˆçº§2ï¼šå¢å¼ºç›‘æ§å’Œå‘Šè­¦

#### 2.1 åœ¨ Step4 è¾“å‡ºä¸­è®°å½•æ—¶é—´æˆ³
ä¿®æ”¹ `src/strategies/step4_multi_timeframe_score.py`ï¼š

```python
# åœ¨æ—¥å¿—ä¸­è®°å½•æ¯ä¸ªå‘¨æœŸçš„æ•°æ®æ—¶é—´
for timeframe, features in data_features.items():
    timestamp = features['timestamp']  # å‡è®¾æœ‰è¿™ä¸ªå­—æ®µ
    lag_minutes = (datetime.now(timezone.utc) - timestamp).total_seconds() / 60
    
    self.logger.info(
        f"[{timeframe}] æ•°æ®æ—¶é—´: {timestamp.strftime('%H:%M:%S')}, "
        f"æ»å: {lag_minutes:.1f}åˆ†é’Ÿ"
    )
    
    # å‘Šè­¦
    if lag_minutes > self.config.get('lag_threshold', {}).get(timeframe, 60):
        self.logger.warning(
            f"[{timeframe}] æ•°æ®æ»åè¿‡é«˜: {lag_minutes:.1f}åˆ†é’Ÿ > é˜ˆå€¼"
        )
```

#### 2.2 åœ¨ Step6 å†³ç­–ä¸­è®°å½•æ—¶é—´é”™ä½
ä¿®æ”¹ `src/strategies/step6_integrated_signal.py`ï¼š

```python
# è®¡ç®—å¤šå‘¨æœŸæ—¶é—´å·®
timestamps = [features['timestamp'] for features in data_features.values()]
time_gap = (max(timestamps) - min(timestamps)).total_seconds() / 60

self.logger.info(f"å¤šå‘¨æœŸæ—¶é—´å·®: {time_gap:.1f}åˆ†é’Ÿ")

if time_gap > 60:
    self.logger.warning(
        f"âš ï¸ å¤šå‘¨æœŸæ—¶é—´é”™ä½ä¸¥é‡: {time_gap:.1f}åˆ†é’Ÿï¼Œå¯èƒ½å½±å“å†³ç­–å‡†ç¡®æ€§"
    )
```

---

### ä¼˜å…ˆçº§3ï¼šå›æµ‹éªŒè¯

#### 3.1 å¯¹æ¯”æµ‹è¯•
ä½¿ç”¨å†å²æ•°æ®å¯¹æ¯”ä»¥ä¸‹ç­–ç•¥çš„è¡¨ç°ï¼š

1. **å½“å‰ç­–ç•¥**ï¼ˆå…¨éƒ¨ä½¿ç”¨ `iloc[-2]`ï¼‰
2. **å®æ—¶ç­–ç•¥**ï¼ˆ5m/15m ä½¿ç”¨ `iloc[-1]`ï¼Œ1h ä½¿ç”¨ `iloc[-2]`ï¼‰
3. **æ¿€è¿›ç­–ç•¥**ï¼ˆå…¨éƒ¨ä½¿ç”¨ `iloc[-1]`ï¼‰

#### 3.2 è¯„ä¼°æŒ‡æ ‡
- å¤æ™®æ¯”ç‡
- æœ€å¤§å›æ’¤
- èƒœç‡
- ç›ˆäºæ¯”
- **å…¥åœºæ—¶æœºå‡†ç¡®æ€§**ï¼ˆæ–°æŒ‡æ ‡ï¼šä¿¡å·å‡ºç°åˆ°å®é™…å…¥åœºçš„å»¶è¿Ÿï¼‰

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. å®æ—¶Kçº¿çš„é£é™©æ§åˆ¶

ä½¿ç”¨ `iloc[-1]`ï¼ˆå®æ—¶Kçº¿ï¼‰æ—¶ï¼ŒKçº¿å°šæœªå®Œæˆï¼Œæ•°æ®ä¼šå˜åŒ–ï¼š

```python
# ç¤ºä¾‹ï¼š16:52æ—¶è¯»å–5må‘¨æœŸï¼ˆ16:50-16:55ï¼‰
df.iloc[-1]['close']  # å½“å‰ä»·æ ¼ï¼Œæ¯ç§’éƒ½åœ¨å˜
df.iloc[-1]['high']   # å½“å‰æœ€é«˜ä»·ï¼Œå¯èƒ½è¿˜ä¼šæ›´æ–°
df.iloc[-1]['volume'] # å½“å‰æˆäº¤é‡ï¼ŒæŒç»­ç´¯ç§¯
```

**é£é™©**ï¼š
- æŠ€æœ¯æŒ‡æ ‡ï¼ˆå¦‚MACDã€RSIï¼‰ä¼šéšKçº¿å˜åŒ–è€Œæ³¢åŠ¨
- å¯èƒ½å‡ºç°"ä¿¡å·é—ªçƒ"ï¼ˆä¸€ä¼šå„¿ä¹°å…¥ï¼Œä¸€ä¼šå„¿å–å‡ºï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ ä¿¡å·ç¡®è®¤æœºåˆ¶ï¼ˆè¿ç»­Næ¬¡å‡ºç°æ‰è§¦å‘ï¼‰
2. è®¾ç½®æœ€å°æŒä»“æ—¶é—´ï¼ˆé¿å…é«˜é¢‘äº¤æ˜“ï¼‰
3. å¯¹å®æ—¶Kçº¿çš„æŒ‡æ ‡åšå¹³æ»‘å¤„ç†

### 2. æ··åˆæ¨¡å¼çš„å®ç°

```python
def get_latest_candle(df, timeframe, mode_config):
    """
    æ ¹æ®é…ç½®è·å–æœ€æ–°Kçº¿
    
    Args:
        df: Kçº¿DataFrame
        timeframe: å‘¨æœŸï¼ˆ'5m', '15m', '1h'ï¼‰
        mode_config: é…ç½®å­—å…¸
    
    Returns:
        æœ€æ–°Kçº¿æ•°æ®ï¼ˆSeriesï¼‰
    """
    settings = mode_config['timeframe_settings'].get(timeframe, {})
    use_realtime = settings.get('use_realtime', False)
    
    if use_realtime:
        # æ£€æŸ¥Kçº¿å®Œæˆåº¦
        completion = calculate_candle_completion(df, timeframe)
        min_completion = settings.get('min_completion_pct', 0)
        
        if completion >= min_completion:
            return df.iloc[-1]  # å®æ—¶Kçº¿
        else:
            # å®Œæˆåº¦ä¸è¶³ï¼Œé™çº§ä½¿ç”¨å·²å®ŒæˆKçº¿
            logger.warning(
                f"[{timeframe}] Kçº¿å®Œæˆåº¦ {completion:.1%} < {min_completion:.1%}ï¼Œ"
                f"ä½¿ç”¨å·²å®ŒæˆKçº¿"
            )
            return df.iloc[-2]
    else:
        return df.iloc[-2]  # å·²å®ŒæˆKçº¿
```

---

## æ¨èæ‰§è¡Œè·¯å¾„

### é˜¶æ®µ1ï¼šå¿«é€ŸéªŒè¯ï¼ˆ1-2å°æ—¶ï¼‰

1. âœ… è¿è¡Œè¯Šæ–­å·¥å…·ï¼ˆå·²å®Œæˆï¼‰
2. é˜…è¯» `DATA_FLOW_STRUCTURED.md` ç†è§£é—®é¢˜
3. ä¿®æ”¹ `config/data_alignment.yaml`ï¼Œè®¾ç½® `mode: 'live_safe'`
4. åœ¨ `builder.py` ä¸­æ·»åŠ ç®€å•çš„if/elseé€»è¾‘ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
5. åœ¨æ¨¡æ‹Ÿç¯å¢ƒæµ‹è¯•1å°æ—¶ï¼Œè§‚å¯Ÿæ»åæ˜¯å¦æ”¹å–„

### é˜¶æ®µ2ï¼šå®Œæ•´å®ç°ï¼ˆ1å¤©ï¼‰

1. å®ç° `get_latest_candle()` å‡½æ•°
2. åœ¨ Step4/Step6 ä¸­æ·»åŠ æ—¶é—´æˆ³æ—¥å¿—
3. æ·»åŠ æ»åå‘Šè­¦æœºåˆ¶
4. çº¸é¢äº¤æ˜“æµ‹è¯•24å°æ—¶

### é˜¶æ®µ3ï¼šå›æµ‹éªŒè¯ï¼ˆ2-3å¤©ï¼‰

1. ä½¿ç”¨æœ€è¿‘1ä¸ªæœˆæ•°æ®å›æµ‹
2. å¯¹æ¯”ä¸åŒæ¨¡å¼çš„è¡¨ç°
3. ä¼˜åŒ–é…ç½®å‚æ•°ï¼ˆå¦‚æœ€å°å®Œæˆåº¦é˜ˆå€¼ï¼‰
4. ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

### é˜¶æ®µ4ï¼šå®ç›˜éƒ¨ç½²ï¼ˆ1å‘¨ï¼‰

1. å°ä»“ä½å®ç›˜æµ‹è¯•ï¼ˆ10-20%èµ„é‡‘ï¼‰
2. å¯†åˆ‡ç›‘æ§æ»åæ—¥å¿—å’Œäº¤æ˜“ç»“æœ
3. æ ¹æ®å®é™…æƒ…å†µå¾®è°ƒé…ç½®
4. é€æ­¥æ‰©å¤§ä»“ä½

---

## å…³é”®æ–‡ä»¶æ¸…å•

### å·²åˆ›å»º/ä¿®æ”¹
- âœ… `DATA_FLOW_STRUCTURED.md` - æ¶æ„æ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰
- âœ… `config/data_alignment.yaml` - å¯¹é½é…ç½®ï¼ˆå·²åˆ›å»ºï¼‰
- âœ… `diagnose_data_lag.py` - è¯Šæ–­å·¥å…·ï¼ˆå·²åˆ›å»ºï¼‰
- âœ… `DIAGNOSIS_SUMMARY.md` - æœ¬æ–‡æ¡£ï¼ˆå·²åˆ›å»ºï¼‰

### å¾…ä¿®æ”¹
- [ ] `src/features/builder.py` - ç‰¹å¾æ„å»ºï¼ˆéœ€æ·»åŠ å®æ—¶/æ»ååˆ‡æ¢ï¼‰
- [ ] `src/strategies/step4_multi_timeframe_score.py` - å¤šå‘¨æœŸè¯„åˆ†ï¼ˆéœ€æ·»åŠ æ—¶é—´æˆ³æ—¥å¿—ï¼‰
- [ ] `src/strategies/step6_integrated_signal.py` - ç»¼åˆä¿¡å·ï¼ˆéœ€æ·»åŠ æ—¶é—´é”™ä½æ£€æµ‹ï¼‰
- [ ] `run_live_trading.py` - ä¸»ç¨‹åºï¼ˆéœ€åŠ è½½å¯¹é½é…ç½®ï¼‰

---

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥ååŠ©ï¼Œè¯·å‚è€ƒï¼š
- è¯Šæ–­å·¥å…·ï¼š`python diagnose_data_lag.py`
- æ¶æ„æ–‡æ¡£ï¼š`DATA_FLOW_STRUCTURED.md`ï¼ˆç¬¬4.3èŠ‚ï¼‰
- é…ç½®æ¨¡æ¿ï¼š`config/data_alignment.yaml`

---

**æœ€åæ›´æ–°**: 2025-12-18  
**çŠ¶æ€**: è¯Šæ–­å®Œæˆï¼Œå¾…å®æ–½æ”¹è¿›
